apiVersion: batch/v1
kind: CronJob
metadata:
  name: webapp-db-init-cron
  namespace: webapp
spec:
  schedule: "0 0 * * *"   # dummy schedule; wonâ€™t run because suspend=true
  suspend: true           # prevent automatic execution
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: db-init
            image: mysql:8.0
            command:
            - sh
            - -c
            - |
              until mysql -h webapp-mariadb.webapp.svc.cluster.local -u webapp-user -e "SELECT 1;" &> /dev/null; do
                echo "Waiting for MariaDB..."
                sleep 3
              done
              mysql -h webapp-mariadb.webapp.svc.cluster.local -u webapp-user webapp-db < /init/init.sql
            env:
            - name: MYSQL_PWD
              valueFrom:
                secretKeyRef:
                  name: mariadb-webapp-password
                  key: password
            volumeMounts:
            - name: init-sql
              mountPath: /init
          volumes:
          - name: init-sql
            configMap:
              name: webapp-db-init
