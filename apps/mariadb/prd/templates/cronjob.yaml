apiVersion: batch/v1
kind: CronJob
metadata:
  name: webapp-db-init-cron
  namespace: webapp
spec:
  schedule: "0 0 * * *"
  suspend: true
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: db-init
            image: mysql:8.0
            command:
            - sh
            - -c
            - |
              until mysql -h webapp-mariadb.webapp.svc.cluster.local -u webapp-user -p"$MYSQL_PWD" -e "SELECT 1;" &> /dev/null; do
                echo "Waiting for MariaDB..."
                sleep 3
              done

              echo "Initializing database tables..."
              mysql -h webapp-mariadb.webapp.svc.cluster.local -u webapp-user -p"$MYSQL_PWD" webapp_db < /init/init.sql
            env:
            - name: MYSQL_PWD
              valueFrom:
                secretKeyRef:
                  name: mariadb-webapp-password
                  key: password
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: webapp-auth-jwt
                  key: admin_password
            - name: OPERATOR_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: webapp-auth-jwt
                  key: operator_password
            volumeMounts:
            - name: init-sql
              mountPath: /init
          volumes:
          - name: init-sql
            configMap:
              name: webapp-db-init
